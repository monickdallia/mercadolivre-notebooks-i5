# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1MyuOCjW1fbk6lV9Aj_cHqrh-ueMc7aDG
"""
import streamlit as st
import pandas as pd
import plotly.express as px

# ConfiguraÃ§Ãµes da pÃ¡gina
st.set_page_config(page_title="Dashboard Mercado Livre - Notebooks", layout="wide")
st.title("ðŸ’» Dashboard - Notebooks Mercado Livre")
st.markdown("AnÃ¡lise de preÃ§os de notebooks com dados coletados automaticamente via scraping.")

# Carregar dados com cache e tempo de expiraÃ§Ã£o
@st.cache_data(ttl=600)  # 10 minutos
def carregar_dados():
    return pd.read_csv("notebooks_mel.csv")

df = carregar_dados()

# Tratar colunas e normalizar marca
df.columns = [col.strip().lower().replace(" ", "_") for col in df.columns]
df["marca"] = df["marca"].str.strip().str.lower().str.capitalize()

# Mostrar data da coleta 
if "data" in df.columns:
    try:
        data_coleta = pd.to_datetime(df["data"]).max().strftime('%d/%m/%Y')
        st.markdown(f"ðŸ“… Dados coletados em: **{data_coleta}**")
    except:
        st.warning("âš ï¸ Coluna 'data' encontrada, mas com valores invÃ¡lidos.")

# Filtros
marcas = sorted(df["marca"].dropna().unique())
marca_selecionada = st.sidebar.multiselect("ðŸ” Filtrar por marca", marcas, default=marcas)

# Faixa de preÃ§o
preco_min = int(df["preco"].min())
preco_max = int(df["preco"].max())
faixa_preco = st.sidebar.slider("ðŸ’° Filtrar por faixa de preÃ§o", preco_min, preco_max, (preco_min, preco_max))

# Aplicar filtros
df_filtrado = df[
    (df["marca"].isin(marca_selecionada)) &
    (df["preco"] >= faixa_preco[0]) &
    (df["preco"] <= faixa_preco[1])
]

# GrÃ¡fico 1: PreÃ§o mÃ©dio por marca
preco_medio = df_filtrado.groupby("marca")["preco"].mean().reset_index()
fig1 = px.bar(preco_medio, x="marca", y="preco", title="ðŸ’° PreÃ§o MÃ©dio por Marca", text_auto='.2s')
fig1.update_layout(xaxis_title="Marca", yaxis_title="PreÃ§o (R$)", template="plotly_white")

# GrÃ¡fico 2: DistribuiÃ§Ã£o de preÃ§os
fig2 = px.histogram(df_filtrado, x="preco", nbins=30, title="ðŸ“Š DistribuiÃ§Ã£o de PreÃ§os")
fig2.update_layout(xaxis_title="PreÃ§o (R$)", yaxis_title="Quantidade", template="plotly_white")

# GrÃ¡fico 3: Top 10 mais caros
top10 = df_filtrado.sort_values(by="preco", ascending=False).head(10)
fig3 = px.bar(top10, x="preco", y="nome", orientation="h", title="ðŸ·ï¸ Top 10 Notebooks Mais Caros", text_auto='.2s')
fig3.update_layout(xaxis_title="PreÃ§o (R$)", yaxis_title="TÃ­tulo", template="plotly_white")

# Layout de grÃ¡ficos
col1, col2 = st.columns(2)
col1.plotly_chart(fig1, use_container_width=True)
col2.plotly_chart(fig2, use_container_width=True)

st.plotly_chart(fig3, use_container_width=True)

# Tabela interativa
st.markdown("### ðŸ“‹ Tabela de Dados Filtrados")
colunas_visiveis = ["nome", "marca", "preco"]
if "preco_promocional" in df.columns:
    colunas_visiveis.append("preco_promocional")
if "link" in df.columns:
    colunas_visiveis.append("link")

st.dataframe(df_filtrado[colunas_visiveis].sort_values(by="preco", ascending=False), use_container_width=True)
